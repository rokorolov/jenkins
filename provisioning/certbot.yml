---
-   name: Set Up certbot
    hosts: all
    remote_user: root
    vars:
        certbot_create_extra_args:
        certbot_create_method: 'webroot'
        certbot_admin_email: change-email.com
        certbot_create_if_missing: true
        certbot_certs:
            -   domains:
                    - change-domain.com
                webroot: "/var/www/html/"

    pre_tasks:
        -   name: Update apt cache.
            apt: update_cache=true cache_valid_time=600
            changed_when: false

        -   name: Install cron (Debian).
            apt: name=cron state=present

        -   name: Check if server is running
            wait_for:
                port: 80
                timeout: 1
            register: port_check
            ignore_errors: yes

        -   name: Up certbot standalone Apache
            shell: "docker run -d --name apache -v /var/www/html:/usr/local/apache2/htdocs/ -p 80:80 httpd:2.4"
            when: port_check.failed == true

    post_tasks:
        -   name: Down certbot Apache
            shell: "docker rm -f apache"
            when: port_check.failed == true

    roles:
        - geerlingguy-certbot
